<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì† ë™ì‘ CAPTCHA ì‹¤í—˜</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@mediapipe/hands@0.4.1675469240/hands.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@mediapipe/drawing_utils@0.3.1675466124/drawing_utils.js" crossorigin="anonymous"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #f8f9fb;
            --surface: #ffffff;
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --danger: #dc2626;
            --danger-hover: #b91c1c;
            --text: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --radius: 12px;
            --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 14px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-icon {
            width: 32px; height: 32px;
            background: var(--primary);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 16px; font-weight: 700;
        }
        .header-title {
            font-weight: 700; font-size: 16px;
        }
        .header-progress {
            margin-left: auto;
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Screens */
        .screen {
            display: none;
            flex: 1;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 32px 24px;
            overflow-y: auto;
            min-height: 0;
        }
        .screen.active { display: flex; }

        .card {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 40px;
            max-width: 560px;
            width: 100%;
            text-align: center;
        }
        .card h1 {
            font-size: 24px; font-weight: 700; margin-bottom: 8px;
        }
        .card h2 {
            font-size: 20px; font-weight: 700; margin-bottom: 16px;
        }
        .card p {
            font-size: 15px; color: var(--text-secondary); line-height: 1.7;
            margin-bottom: 16px;
        }
        .card .subtitle {
            font-size: 14px; color: var(--text-secondary); margin-bottom: 24px;
        }

        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 12px 32px;
            border-radius: 10px;
            font-family: inherit;
            font-size: 15px; font-weight: 600;
            border: none; cursor: pointer;
            transition: all 0.15s ease;
            gap: 8px;
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary {
            background: var(--primary); color: white;
        }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-danger {
            background: var(--danger); color: white;
        }
        .btn-danger:hover { background: var(--danger-hover); }
        .btn-outline {
            background: transparent; color: var(--text);
            border: 2px solid var(--border);
        }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        .btn-outline.selected {
            border-color: var(--primary); color: var(--primary);
            background: #eff6ff;
        }
        .btn:disabled {
            opacity: 0.5; cursor: not-allowed; transform: none;
        }
        .btn-lg { padding: 14px 40px; font-size: 16px; }

        /* Hand selection */
        .hand-select-group {
            display: flex; gap: 16px; justify-content: center;
            margin: 24px 0;
        }
        .hand-btn {
            flex: 1; max-width: 180px;
            padding: 24px 16px;
            border-radius: var(--radius);
            border: 2px solid var(--border);
            background: var(--surface);
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: center;
        }
        .hand-btn:hover { border-color: var(--primary); }
        .hand-btn.selected {
            border-color: var(--primary);
            background: #eff6ff;
        }
        .hand-btn .hand-emoji { font-size: 40px; margin-bottom: 8px; }
        .hand-btn .hand-label { font-weight: 600; font-size: 15px; }

        /* Trial screen */
        .trial-container {
            display: none;
            flex: 1;
            flex-direction: column;
            width: 100%;
            min-height: 0;
            overflow: hidden;
        }
        .trial-container.active { display: flex; }

        .trial-content {
            display: flex;
            flex: 1;
            gap: 16px;
            padding: 16px;
            overflow: hidden;
        }

        .trial-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            min-height: 0;
        }

        .panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .panel-title {
            font-weight: 600; font-size: 14px;
        }
        .panel-badge {
            font-size: 12px;
            padding: 3px 10px;
            background: #f1f5f9;
            border-radius: 20px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .video-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0f172a;
            position: relative;
            min-height: 0;
        }
        .video-area video {
            width: 100%; height: 100%;
            object-fit: contain;
        }

        .video-progress-bar {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 8px;
            background: rgba(255,255,255,0.25);
        }
        .video-progress-fill {
            height: 100%;
            background: #60a5fa;
            width: 0%;
            transition: width 0.1s linear;
            box-shadow: 0 0 6px rgba(96,165,250,0.7);
        }
        .video-time {
            position: absolute;
            bottom: 16px; right: 12px;
            font-size: 13px;
            color: #ffffff;
            background: rgba(0,0,0,0.65);
            padding: 3px 10px;
            border-radius: 6px;
            font-family: monospace;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* Video end overlay */
        .video-end-overlay {
            position: absolute; inset: 0;
            background: #0f172a;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            color: white; gap: 10px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .video-end-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .video-end-overlay .end-icon { font-size: 36px; }
        .video-end-overlay p { font-size: 14px; opacity: 0.75; }

        .camera-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0f172a;
            position: relative;
            min-height: 0;
        }
        .camera-area canvas {
            width: 100%; height: 100%;
            object-fit: contain;
        }
        .camera-area video { display: none; }

        .camera-placeholder {
            color: #94a3b8;
            text-align: center;
            font-size: 14px;
            padding: 24px;
        }

        .panel-controls {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-shrink: 0;
        }

        /* Status indicator */
        .status-bar {
            padding: 8px 16px;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            flex-shrink: 0;
        }
        .status-bar.waiting { background: #fef3c7; color: #92400e; }
        .status-bar.detecting { background: #dbeafe; color: #1e40af; }
        .status-bar.recording { background: #dcfce7; color: #166534; }
        .status-bar.complete { background: #dcfce7; color: #166534; font-weight: 700; }
        .status-bar.recording .rec-dot {
            display: inline-block; width: 8px; height: 8px;
            background: #dc2626; border-radius: 50%;
            margin-right: 6px; animation: blink 1s infinite;
        }
        @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.3;} }

        /* Progress dots */
        .progress-dots {
            display: flex; gap: 6px; justify-content: center;
            padding: 12px 16px;
            flex-shrink: 0;
        }
        .progress-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
            background: var(--border);
            transition: all 0.2s;
        }
        .progress-dot.done { background: var(--primary); }
        .progress-dot.current {
            background: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed; inset: 0;
            background: rgba(255,255,255,0.9);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 1000; gap: 16px;
        }
        .loading-overlay.hidden { display: none; }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .trial-content {
                flex-direction: column;
                padding: 6px;
                gap: 6px;
            }
            /* ì°¸ê³  ì˜ìƒ íŒ¨ë„: ì‘ê²Œ */
            .trial-panel:first-child {
                flex: 0 0 auto;
                height: 28vh;
                min-height: 0;
            }
            /* ì¹´ë©”ë¼ íŒ¨ë„: í¬ê²Œ */
            .trial-panel:last-child {
                flex: 1 1 0;
                min-height: 0;
            }
            /* ì§„í–‰ ë„íŠ¸ ì»´íŒ©íŠ¸ */
            .progress-dots { padding: 6px 16px; }
            /* í—¤ë” ì»´íŒ©íŠ¸ */
            .header { padding: 8px 12px; }
            .header-title { font-size: 14px; }
            /* íŒ¨ë„ í—¤ë” ì»´íŒ©íŠ¸ */
            .panel-header { padding: 6px 12px; }
            .panel-title { font-size: 13px; }
            /* ë²„íŠ¼ ì»´íŒ©íŠ¸ */
            .panel-controls { padding: 8px 12px; }
            .btn { padding: 9px 20px; font-size: 14px; }
            /* ì¹´ë“œ */
            .card { padding: 24px 16px; }
            .card h1 { font-size: 20px; }
            .hand-select-group { gap: 12px; }
        }

        /* Instruction list */
        .instruction-steps {
            text-align: left;
            margin: 20px 0;
            padding: 20px 24px;
            background: #f8fafc;
            border-radius: 10px;
        }
        .instruction-steps li {
            font-size: 14px;
            line-height: 1.8;
            color: var(--text);
            margin-bottom: 4px;
        }

        .info-box {
            background: #eff6ff;
            border-radius: 8px;
            padding: 14px 18px;
            font-size: 13px;
            color: #1e40af;
            margin-top: 16px;
            line-height: 1.6;
        }

        /* Help button in header */
        .btn-help {
            margin-left: auto;
            background: #eff6ff;
            border: 1.5px solid #bfdbfe;
            color: var(--primary);
            border-radius: 8px;
            padding: 5px 14px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex; align-items: center; gap: 5px;
            transition: background 0.15s;
        }
        .btn-help:hover { background: #dbeafe; }

        /* Instructions Modal */
        .modal-backdrop {
            position: fixed; inset: 0;
            background: rgba(15,23,42,0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 500;
            padding: 24px;
        }
        .modal-backdrop.hidden { display: none; }
        .modal-box {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: 0 8px 40px rgba(0,0,0,0.18);
            padding: 36px 36px 28px;
            max-width: 520px;
            width: 100%;
            text-align: center;
            max-height: 90dvh;
            overflow-y: auto;
        }
        .modal-box h2 { font-size: 20px; font-weight: 700; margin-bottom: 16px; }
        .modal-box p { font-size: 15px; color: var(--text-secondary); line-height: 1.7; margin-bottom: 16px; }
        .modal-close-row {
            display: flex; justify-content: center; margin-top: 20px; gap: 10px;
        }

        /* Camera flip button */
        .btn-cam-flip {
            background: #f1f5f9;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            padding: 4px 10px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.15s;
            line-height: 1;
        }
        .btn-cam-flip:hover { background: #e2e8f0; }
        .btn-cam-flip:disabled { opacity: 0.4; cursor: not-allowed; }

        /* Next trial overlay */
        .next-overlay {
            position: absolute; inset: 0;
            background: rgba(15,23,42,0.85);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            color: white; z-index: 10;
        }
        .next-overlay.hidden { display: none; }
        .next-overlay .check { font-size: 48px; margin-bottom: 12px; }
        .next-overlay p { font-size: 15px; opacity: 0.8; }
    </style>
</head>
<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <p style="font-size:14px; color:var(--text-secondary);">MediaPipe ëª¨ë¸ ë¡œë”© ì¤‘...</p>
</div>

<!-- Header -->
<div class="header">
    <div class="header-icon">H</div>
    <div class="header-title">Hand CAPTCHA ì‹¤í—˜</div>
    <button class="btn-help" onclick="openInstructions()">â“ ì‹¤í—˜ ì•ˆë‚´</button>
    <div class="header-progress" id="headerProgress" style="margin-left:12px;"></div>
</div>

<!-- Screen 1: Start -->
<div class="screen active" id="screenStart">
    <div class="card">
        <h1>ğŸ‘‹ ì† ë™ì‘ ì¸ì‹ ì‹¤í—˜</h1>
        <p class="subtitle">ì¸ê°„ê³¼ AIì˜ ê°€ë ¤ì§„ ì† ì¶”ì • ëŠ¥ë ¥ ë¹„êµ ì—°êµ¬</p>
        <p>ë³¸ ì‹¤í—˜ì— ì°¸ì—¬í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.<br>
        ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë”°ë¼í•˜ê¸°ì— ì‚¬ìš©í•  ì†ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
        <br>
        <button class="btn btn-primary btn-lg" onclick="showScreen('screenHandSelect')">ì‹œì‘í•˜ê¸°</button>
    </div>
</div>

<!-- Instructions Modal (íŒì—…) -->
<div class="modal-backdrop hidden" id="instructionsModal">
    <div class="modal-box">
        <h2>ì‹¤í—˜ ì•ˆë‚´</h2>
        <p>ë³¸ ì‹¤í—˜ì€ <strong>ì¸ê°„ê³¼ AIì˜ ê°€ë ¤ì§„ ì† ì¶”ì • ëŠ¥ë ¥ì„ ë¹„êµ</strong>í•˜ê¸° ìœ„í•´ ì§„í–‰ë˜ë©°, ì†Œìš” ì‹œê°„ì€ ì•½ <strong>2ë¶„</strong>ì…ë‹ˆë‹¤.</p>
        <ol class="instruction-steps">
            <li>ì œì‹œë˜ëŠ” <strong>5~6ì´ˆ ë¶„ëŸ‰ì˜ ì¼ë¶€ê°€ ê°€ë ¤ì§„ ì† ë™ì‘ ì˜ìƒ</strong>ì„ ë´…ë‹ˆë‹¤.</li>
            <li>ì˜ìƒì— ì œì‹œëœ <strong>ì¼ë¶€ê°€ ê°€ë ¤ì§„ ì† ë™ì‘ì„</strong> ë”°ë¼í•  ì¤€ë¹„ê°€ ë˜ì—ˆë‹¤ë©´ <strong>'ë”°ë¼í•˜ê¸°'</strong> ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤.</li>
            <li>ì¹´ë©”ë¼ì— ì†ì´ ì¸ì‹ë˜ë©´ <strong>ìë™ìœ¼ë¡œ ê¸°ë¡ì´ ì‹œì‘</strong>ë©ë‹ˆë‹¤.</li>
            <li>ì œì‹œëœ ì˜ìƒì˜ ì† ë™ì‘ì„ <strong>ìµœëŒ€í•œ ë¹„ìŠ·í•˜ê²Œ</strong> ë”°ë¼í•˜ì„¸ìš”.</li>
            <li>ì˜ìƒì´ ëë‚˜ë©´ <strong>ìë™ìœ¼ë¡œ ê¸°ë¡ì´ ì¢…ë£Œ</strong>ë˜ê³  ë‹¤ìŒ ì˜ìƒìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.</li>
            <li>ì´ <strong>9ê°œ</strong>ì˜ ì˜ìƒì— ëŒ€í•´ ë°˜ë³µí•©ë‹ˆë‹¤.</li>
        </ol>
        <div class="info-box">
            â„¹ï¸ ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ê¶Œí•œ ìš”ì²­ ì‹œ 'í—ˆìš©'ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.
        </div>
        <div class="modal-close-row">
            <button class="btn btn-primary" id="modalConfirmBtn" onclick="closeInstructions()">ì‹¤í—˜ ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>
</div>

<!-- Screen 3 (êµ¬ Screen 2): Hand Selection -->
<div class="screen" id="screenHandSelect">
    <div class="card">
        <h2>ì£¼ì† ì„ íƒ</h2>
        <p>ë”°ë¼í•˜ê¸°ë¥¼ ìˆ˜í–‰í•  ì†ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
        <div class="hand-select-group">
            <div class="hand-btn" onclick="selectHand('left', this)" id="btnLeft">
                <div class="hand-emoji">ğŸ¤š</div>
                <div class="hand-label">ì™¼ì†</div>
            </div>
            <div class="hand-btn" onclick="selectHand('right', this)" id="btnRight">
                <div class="hand-emoji">âœ‹</div>
                <div class="hand-label">ì˜¤ë¥¸ì†</div>
            </div>
        </div>
        <button class="btn btn-primary btn-lg" id="btnStartTrials" disabled onclick="startTrials()">ì‹¤í—˜ ì‹œì‘</button>
    </div>
</div>

<!-- Screen 4: Trial -->
<div class="trial-container" id="screenTrial">
    <!-- Progress dots -->
    <div class="progress-dots" id="progressDots"></div>

    <div class="trial-content">
        <!-- Left panel: Reference video -->
        <div class="trial-panel">
            <div class="panel-header">
                <span class="panel-title">ğŸ“¹ ì°¸ê³  ì˜ìƒ</span>
                <span class="panel-badge" id="trialCounter">1 / 9</span>
            </div>
            <div class="video-area">
                <video id="refVideo" loop muted playsinline></video>
                <div class="video-end-overlay" id="videoEndOverlay">
                    <div class="end-icon">âœ…</div>
                    <p>ë™ì‘ ì¸ì‹ ì™„ë£Œ ì¤‘...</p>
                </div>
                <div class="video-loading" id="videoLoading" style="position:absolute;color:#94a3b8;font-size:14px;">ì˜ìƒ ë¡œë”© ì¤‘...</div>
                <div class="video-progress-bar"><div class="video-progress-fill" id="videoProgressFill"></div></div>
                <div class="video-time" id="videoTime">0:00 / 0:00</div>
            </div>
        </div>

        <!-- Right panel: Camera -->
        <div class="trial-panel">
            <div class="panel-header">
                <span class="panel-title">ğŸ“· ì¹´ë©”ë¼</span>
                <button class="btn-cam-flip" id="btnCamFlip" onclick="flipCamera()" title="ì¹´ë©”ë¼ ì „í™˜">ğŸ”„</button>
                <span class="panel-badge" id="frameCounter">0 í”„ë ˆì„</span>
            </div>
            <div class="camera-area" id="cameraArea">
                <video id="cameraVideo" playsinline autoplay></video>
                <canvas id="cameraCanvas"></canvas>
                <div class="camera-placeholder" id="cameraPlaceholder">
                    ì¹´ë©”ë¼ë¥¼ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘...
                </div>
            </div>
            <!-- Status bar -->
            <div class="status-bar waiting" id="statusBar">
                ì˜ìƒì„ ë³´ê³  ì¤€ë¹„ë˜ë©´ 'ë”°ë¼í•˜ê¸°' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”
            </div>
            <div class="panel-controls">
                <button class="btn btn-outline" id="btnCamToggle" onclick="toggleCamera()">
                    ğŸ”„ ì¹´ë©”ë¼ ì „í™˜
                </button>
                <button class="btn btn-primary" id="btnRecord" onclick="startRecording()">
                    â–¶ ë”°ë¼í•˜ê¸°
                </button>
                <button class="btn btn-danger" id="btnStop" onclick="stopRecording()" disabled>
                    â–  ë”°ë¼í•˜ê¸° ì¢…ë£Œ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Screen 5: Thank you -->
<div class="screen" id="screenThanks">
    <div class="card">
        <h1>ğŸ‰ ì‹¤í—˜ ì™„ë£Œ!</h1>
        <p class="subtitle">ëª¨ë“  ì˜ìƒì— ëŒ€í•œ ë”°ë¼í•˜ê¸°ë¥¼ ì™„ë£Œí•˜ì˜€ìŠµë‹ˆë‹¤.</p>
        <p>ì°¸ì—¬í•´ ì£¼ì…”ì„œ ì§„ì‹¬ìœ¼ë¡œ ê°ì‚¬í•©ë‹ˆë‹¤.<br>
        ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹¤í—˜ ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê³ ,<br>
        ì—°êµ¬ìì—ê²Œ ì „ë‹¬í•´ ì£¼ì„¸ìš”.</p>
        <br>
        <button class="btn btn-primary btn-lg" onclick="downloadResults()">ğŸ“¥ ë°ì´í„° ë‹¤ìš´ë¡œë“œ</button>
        <p style="margin-top:16px; font-size:13px; color:var(--text-secondary);">
            ë‹¤ìš´ë¡œë“œëœ JSON íŒŒì¼ì„ ì—°êµ¬ìì—ê²Œ ì „ë‹¬í•´ ì£¼ì„¸ìš”.
        </p>
    </div>
</div>

<script>
// ===== CONFIG =====
const VIDEO_BASE = 'https://mukgore.github.io/handcaptcha/';

const VIDEOS = {
    right: [
        { id: 'r1_level1_MCP', action: 1, level: 1, joint: 'MCP' },
        { id: 'r1_level2_PIP', action: 1, level: 2, joint: 'PIP' },
        { id: 'r1_level3_DIP', action: 1, level: 3, joint: 'DIP' },
        { id: 'r2_level1_MCP', action: 2, level: 1, joint: 'MCP' },
        { id: 'r2_level2_PIP', action: 2, level: 2, joint: 'PIP' },
        { id: 'r2_level3_DIP', action: 2, level: 3, joint: 'DIP' },
        { id: 'r3_level1_MCP', action: 3, level: 1, joint: 'MCP' },
        { id: 'r3_level2_PIP', action: 3, level: 2, joint: 'PIP' },
        { id: 'r3_level3_DIP', action: 3, level: 3, joint: 'DIP' },
    ],
    left: [
        { id: 'l1_level1_MCP', action: 1, level: 1, joint: 'MCP' },
        { id: 'l1_level2_PIP', action: 1, level: 2, joint: 'PIP' },
        { id: 'l1_level3_DIP', action: 1, level: 3, joint: 'DIP' },
        { id: 'l2_level1_MCP', action: 2, level: 1, joint: 'MCP' },
        { id: 'l2_level2_PIP', action: 2, level: 2, joint: 'PIP' },
        { id: 'l2_level3_DIP', action: 2, level: 3, joint: 'DIP' },
        { id: 'l3_level1_MCP', action: 3, level: 1, joint: 'MCP' },
        { id: 'l3_level2_PIP', action: 3, level: 2, joint: 'PIP' },
        { id: 'l3_level3_DIP', action: 3, level: 3, joint: 'DIP' },
    ]
};

// ===== STATE =====
let selectedHand = null;
let currentTrialIndex = 0;
let trialVideos = [];
let isRecording = false;
let isWaitingForHand = false;
let recordingStartTime = 0;
let currentTrialFrames = [];
let allResults = [];
let participantId = crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36) + Math.random().toString(36).slice(2);

// MediaPipe
let hands = null;
let cameraStream = null;
let animFrameId = null;
let lastLandmarks = null;
let currentFacingMode = 'user'; // 'user' = ì „ë©´, 'environment' = í›„ë©´

// DOM elements
const refVideo = document.getElementById('refVideo');
const cameraVideo = document.getElementById('cameraVideo');
const cameraCanvas = document.getElementById('cameraCanvas');
const canvasCtx = cameraCanvas.getContext('2d');
const cameraPlaceholder = document.getElementById('cameraPlaceholder');
const statusBar = document.getElementById('statusBar');
const btnRecord = document.getElementById('btnRecord');
const btnStop = document.getElementById('btnStop');
const frameCounter = document.getElementById('frameCounter');
const trialCounter = document.getElementById('trialCounter');
const progressDots = document.getElementById('progressDots');
const headerProgress = document.getElementById('headerProgress');
const loadingOverlay = document.getElementById('loadingOverlay');
const videoProgressFill = document.getElementById('videoProgressFill');
const videoTime = document.getElementById('videoTime');

// Video progress bar update
function formatTime(sec) {
    const s = Math.floor(sec);
    return `${Math.floor(s / 60)}:${String(s % 60).padStart(2, '0')}`;
}
refVideo.addEventListener('timeupdate', () => {
    if (refVideo.duration) {
        const pct = (refVideo.currentTime / refVideo.duration) * 100;
        videoProgressFill.style.width = pct + '%';
        videoTime.textContent = `${formatTime(refVideo.currentTime)} / ${formatTime(refVideo.duration)}`;
    }
});

// ===== INSTRUCTIONS MODAL =====
function openInstructions() {
    document.getElementById('instructionsModal').classList.remove('hidden');
}

function closeInstructions() {
    document.getElementById('instructionsModal').classList.add('hidden');
}

async function flipCamera() {
    currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
    const btn = document.getElementById('btnCamFlip');
    btn.disabled = true;

    // Stop existing stream
    if (cameraStream) cameraStream.getTracks().forEach(t => t.stop());
    if (animFrameId) cancelAnimationFrame(animFrameId);

    try {
        cameraStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: currentFacingMode, width: { ideal: 640 }, height: { ideal: 480 } }
        });
        cameraVideo.srcObject = cameraStream;
        await cameraVideo.play();
        cameraCanvas.width = cameraVideo.videoWidth || 640;
        cameraCanvas.height = cameraVideo.videoHeight || 480;
        startCameraLoop();
    } catch (e) {
        console.error('Camera flip error:', e);
        // Revert
        currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
    }
    btn.disabled = false;
}


function showScreen(id) {
    document.querySelectorAll('.screen, .trial-container').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

// ===== HAND SELECTION =====
function selectHand(hand, btn) {
    selectedHand = hand;
    document.querySelectorAll('.hand-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    document.getElementById('btnStartTrials').disabled = false;
}

// ===== MEDIAPIPE INIT =====
async function initMediaPipe() {
    hands = new Hands({
        locateFile: (file) => `https://unpkg.com/@mediapipe/hands@0.4.1675469240/${file}`
    });

    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    hands.onResults(onMediaPipeResults);

    await hands.initialize();
    loadingOverlay.classList.add('hidden');
}

// ===== CAMERA =====
async function initCamera() {
    try {
        cameraStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: currentFacingMode, width: { ideal: 640 }, height: { ideal: 480 } }
        });
        cameraVideo.srcObject = cameraStream;
        await cameraVideo.play();

        cameraCanvas.width = cameraVideo.videoWidth || 640;
        cameraCanvas.height = cameraVideo.videoHeight || 480;
        cameraPlaceholder.style.display = 'none';
        cameraCanvas.style.display = 'block';

        startCameraLoop();
    } catch (e) {
        cameraPlaceholder.textContent = 'ì¹´ë©”ë¼ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.';
        console.error('Camera error:', e);
    }
}

async function toggleCamera() {
    const btn = document.getElementById('btnCamToggle');
    btn.disabled = true;
    btn.textContent = 'ì „í™˜ ì¤‘...';

    // Stop current stream
    if (animFrameId) cancelAnimationFrame(animFrameId);
    if (cameraStream) cameraStream.getTracks().forEach(t => t.stop());

    currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';

    await initCamera();

    btn.disabled = false;
    btn.innerHTML = currentFacingMode === 'user' ? 'ğŸ”„ ì¹´ë©”ë¼ ì „í™˜' : 'ğŸ”„ ì¹´ë©”ë¼ ì „í™˜';
}

function startCameraLoop() {
    async function loop() {
        if (cameraVideo.readyState >= 2) {
            await hands.send({ image: cameraVideo });
        }
        animFrameId = requestAnimationFrame(loop);
    }
    loop();
}

function onMediaPipeResults(results) {
    // Draw camera feed
    canvasCtx.save();
    canvasCtx.clearRect(0, 0, cameraCanvas.width, cameraCanvas.height);

    if (currentFacingMode === 'user') {
        // Mirror for front camera
        canvasCtx.translate(cameraCanvas.width, 0);
        canvasCtx.scale(-1, 1);
    }
    canvasCtx.drawImage(results.image, 0, 0, cameraCanvas.width, cameraCanvas.height);
    canvasCtx.restore();

    const hasHand = results.multiHandLandmarks && results.multiHandLandmarks.length > 0;

    if (hasHand) {
        const landmarks = results.multiHandLandmarks[0];

        // Mirror landmarks only for front camera
        const displayLandmarks = currentFacingMode === 'user'
            ? landmarks.map(l => ({ x: 1 - l.x, y: l.y, z: l.z }))
            : landmarks;

        drawConnectors(canvasCtx, displayLandmarks, HAND_CONNECTIONS, { color: '#00FF88', lineWidth: 2 });
        drawLandmarks(canvasCtx, displayLandmarks, { color: '#FF4444', lineWidth: 1, radius: 3 });

        lastLandmarks = landmarks; // Store original (not mirrored)

        // If waiting for hand detection to start recording
        if (isWaitingForHand) {
            isWaitingForHand = false;
            isRecording = true;
            recordingStartTime = performance.now();
            currentTrialFrames = [];
            setStatus('recording', '<span class="rec-dot"></span>ê¸°ë¡ ì¤‘... ë™ì‘ì„ ë”°ë¼í•´ ì£¼ì„¸ìš”');
        }

        // Record frame
        if (isRecording) {
            const handedness = results.multiHandedness?.[0]?.label || 'Unknown';
            const score = results.multiHandedness?.[0]?.score || 0;

            currentTrialFrames.push({
                frameIndex: currentTrialFrames.length,
                timestamp: performance.now() - recordingStartTime,
                landmarks: landmarks.map(l => [
                    Math.round(l.x * 100000) / 100000,
                    Math.round(l.y * 100000) / 100000,
                    Math.round(l.z * 100000) / 100000
                ]),
                handedness: handedness,
                score: Math.round(score * 1000) / 1000
            });

            frameCounter.textContent = `${currentTrialFrames.length} í”„ë ˆì„`;
        }
    } else {
        lastLandmarks = null;
        if (isRecording) {
            // Still recording but no hand detected â€” record null frame
            currentTrialFrames.push({
                frameIndex: currentTrialFrames.length,
                timestamp: performance.now() - recordingStartTime,
                landmarks: null,
                handedness: null,
                score: null
            });
            frameCounter.textContent = `${currentTrialFrames.length} í”„ë ˆì„`;
        }
    }
}

// ===== STATUS BAR =====
function setStatus(type, html) {
    statusBar.className = 'status-bar ' + type;
    statusBar.innerHTML = html;
}

// ===== SHUFFLE (no same-action consecutive) =====
function shuffleVideos(videos) {
    // Try up to 100 times to find a valid shuffle
    for (let attempt = 0; attempt < 100; attempt++) {
        const shuffled = [...videos];
        // Fisher-Yates shuffle
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        // Check: no two consecutive videos have the same action
        let valid = true;
        for (let i = 1; i < shuffled.length; i++) {
            if (shuffled[i].action === shuffled[i - 1].action) {
                valid = false;
                break;
            }
        }
        if (valid) return shuffled;
    }
    // Fallback: return any shuffle if no valid one found
    const shuffled = [...videos];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

// ===== TRIALS =====
async function startTrials() {
    trialVideos = shuffleVideos(VIDEOS[selectedHand]);
    console.log('Trial order:', trialVideos.map(v => v.id));
    currentTrialIndex = 0;
    allResults = [];

    showScreen('screenTrial');

    // Build progress dots
    progressDots.innerHTML = trialVideos.map((_, i) =>
        `<div class="progress-dot" id="dot${i}"></div>`
    ).join('');

    await initCamera();
    loadTrial(0);

    // Show instructions modal over the trial screen
    openInstructions();
}

function loadTrial(index) {
    currentTrialIndex = index;
    const trial = trialVideos[index];

    // Update UI
    trialCounter.textContent = `${index + 1} / ${trialVideos.length}`;
    headerProgress.textContent = `${index + 1} / ${trialVideos.length}`;
    frameCounter.textContent = '0 í”„ë ˆì„';

    // Update progress dots
    document.querySelectorAll('.progress-dot').forEach((dot, i) => {
        dot.className = 'progress-dot';
        if (i < index) dot.classList.add('done');
        if (i === index) dot.classList.add('current');
    });

    // Reset video end overlay
    document.getElementById('videoEndOverlay').classList.remove('visible');
    refVideo.style.opacity = '1';

    // Load video
    const videoLoading = document.getElementById('videoLoading');
    videoLoading.style.display = 'block';
    videoProgressFill.style.width = '0%';
    videoTime.textContent = '0:00 / 0:00';
    const videoUrl = VIDEO_BASE + trial.id + '.mp4';
    console.log('Loading video:', videoUrl);
    refVideo.loop = true;
    refVideo.src = videoUrl;
    refVideo.load();
    refVideo.oncanplay = () => {
        videoLoading.style.display = 'none';
        refVideo.play().catch(e => console.warn('Video play failed:', e));
    };
    refVideo.onerror = (e) => {
        videoLoading.textContent = 'ì˜ìƒ ë¡œë”© ì‹¤íŒ¨: ' + videoUrl;
        console.error('Video load error:', refVideo.error);
    };

    // Reset state
    isRecording = false;
    isWaitingForHand = false;
    currentTrialFrames = [];
    btnRecord.disabled = false;
    btnStop.disabled = true;
    setStatus('waiting', 'ì˜ìƒì„ ë³´ê³  ì¤€ë¹„ë˜ë©´ \'ë”°ë¼í•˜ê¸°\' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”');
}

function startRecording() {
    isWaitingForHand = true;
    btnRecord.disabled = true;
    btnStop.style.display = 'none'; // ìˆ˜ë™ ì¢…ë£Œ ë²„íŠ¼ ìˆ¨ê¹€
    setStatus('detecting', 'ì†ì„ ì¹´ë©”ë¼ì— ë³´ì—¬ì£¼ì„¸ìš”... ì¸ì‹ ëŒ€ê¸° ì¤‘');

    // Restart video from the beginning (remove loop so ended fires)
    refVideo.loop = false;
    refVideo.currentTime = 0;
    refVideo.play().catch(e => console.warn('Video play failed:', e));

    // Auto-stop when video ends
    refVideo.addEventListener('ended', onVideoEnded, { once: true });

    // If hand is already detected, start immediately
    if (lastLandmarks) {
        isWaitingForHand = false;
        isRecording = true;
        recordingStartTime = performance.now();
        currentTrialFrames = [];
        setStatus('recording', '<span class="rec-dot"></span>ê¸°ë¡ ì¤‘... ë™ì‘ì„ ë”°ë¼í•´ ì£¼ì„¸ìš”');
    }
}

function onVideoEnded() {
    // Immediately hide video
    document.getElementById('videoEndOverlay').classList.add('visible');
    setStatus('complete', 'âœ… ì¸ì‹ ì™„ë£Œ! ì ì‹œ í›„ ë‹¤ìŒ ì˜ìƒìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤...');

    // 1 second grace period then stop
    setTimeout(() => {
        stopRecording();
    }, 1000);
}

function stopRecording() {
    if (!isRecording && !isWaitingForHand) return; // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
    isRecording = false;
    isWaitingForHand = false;
    btnStop.style.display = '';
    btnStop.disabled = true;

    const trial = trialVideos[currentTrialIndex];

    // Save trial data
    allResults.push({
        trialIndex: currentTrialIndex,
        videoId: trial.id,
        action: trial.action,
        level: trial.level,
        occlusionJoint: trial.joint,
        hand: selectedHand,
        totalFrames: currentTrialFrames.length,
        detectedFrames: currentTrialFrames.filter(f => f.landmarks !== null).length,
        frames: currentTrialFrames
    });

    // Update progress dot
    document.getElementById(`dot${currentTrialIndex}`).className = 'progress-dot done';

    // Next trial or finish
    if (currentTrialIndex < trialVideos.length - 1) {
        setStatus('waiting', 'âœ… ì €ì¥ ì™„ë£Œ! ë‹¤ìŒ ì˜ìƒìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤...');
        setTimeout(() => {
            loadTrial(currentTrialIndex + 1);
        }, 1500);
    } else {
        // All done
        refVideo.pause();
        if (animFrameId) cancelAnimationFrame(animFrameId);
        if (cameraStream) cameraStream.getTracks().forEach(t => t.stop());
        showScreen('screenThanks');
    }
}

// ===== DOWNLOAD RESULTS =====
function downloadResults() {
    const data = {
        experimentInfo: {
            participantId: participantId,
            selectedHand: selectedHand,
            userAgent: navigator.userAgent,
            screenWidth: screen.width,
            screenHeight: screen.height,
            completedAt: new Date().toISOString(),
            totalTrials: allResults.length,
            trialOrder: trialVideos.map(v => v.id)
        },
        trials: allResults
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `hand_captcha_${selectedHand}_${participantId.slice(0, 8)}_${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ===== INIT =====
initMediaPipe().catch(err => {
    console.error('MediaPipe init error:', err);
    loadingOverlay.innerHTML = `
        <p style="color:var(--danger); font-size:15px; text-align:center; padding:24px;">
            MediaPipe ëª¨ë¸ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>
            í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.
        </p>
    `;
});
</script>

</body>
</html>
